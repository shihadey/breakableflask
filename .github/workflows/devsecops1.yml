name: TP Orchestration avanc√©e 

on:
  push:
    branches:
      - master
  pull_request:

jobs:
  Dependances:
    name: V√©rification et installation des d√©pendances
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: V√©rifier que requirements.txt existe
        run: |
          if [ ! -f "requirements.txt" ]; then
            echo "‚ùå requirements.txt manquant !"
            exit 1
          fi
          echo "‚úÖ requirements.txt trouv√©"
      
      - name: V√©rifier que requirements.txt n'est pas vide
        run: |
          if [ ! -s "requirements.txt" ]; then
            echo "‚ùå requirements.txt est vide !"
            exit 1
          fi
          echo "‚úÖ requirements.txt non vide"
      
      - name: Tester l'installation des d√©pendances
        run: |
          pip install -r requirements.txt
          echo "‚úÖ D√©pendances installables"

  Dockerfile:
    name: V√©rification et construction Docker
    runs-on: ubuntu-latest
    needs: Dependances
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: V√©rifier que Dockerfile existe
        run: |
          if [ ! -f "Dockerfile" ]; then
            echo "‚ùå Dockerfile manquant !"
            exit 1
          fi
          echo "‚úÖ Dockerfile trouv√©"
      
      - name: Tester la construction Docker
        run: |
          docker build -t imgvulne:1.1 .
          echo "‚úÖ Dockerfile OK ‚Äî image Docker construite"

  Vulnerabilities:
    name: Scan des vuln√©rabilit√©s
    runs-on: ubuntu-latest
    needs: Dockerfile
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Installer jq et column pour formatage
        run: sudo apt-get update && sudo apt-get install -y jq bsdmainutils
      
      - name: Scanner vuln√©rabilit√©s des d√©pendances Python
        id: scan-python
        continue-on-error: true
        run: |
          echo "üîç Scan des vuln√©rabilit√©s dans requirements.txt"
          echo "================================================"
          
          # Scan avec Trivy et sauvegarde du r√©sultat
          docker run --rm \
            -v "$PWD":/project \
            -v $HOME/.cache/trivy:/root/.cache/ \
            aquasec/trivy:latest fs --format json --severity HIGH,CRITICAL /project/requirements.txt \
          > python-scan.json
          
          # Extraire les vuln√©rabilit√©s
          VULN_COUNT=$(jq '[.Results[]?.Vulnerabilities[]?] | length' python-scan.json)
          
          echo "VULN_COUNT=$VULN_COUNT" >> $GITHUB_ENV
          
          if [ "$VULN_COUNT" -gt 0 ]; then
            echo "‚ö†Ô∏è  $VULN_COUNT vuln√©rabilit√©s trouv√©es dans requirements.txt"
            echo ""
            echo "D√©tails des vuln√©rabilit√©s :"
            echo "----------------------------"
            
            jq -r '
              ["PACKAGE","VERSION","VULN√âRABILIT√â","S√âV√âRIT√â","TITRE"],
              (.Results[]?.Vulnerabilities[]? | 
                [.PkgName, .InstalledVersion, .VulnerabilityID, .Severity, .Title]) 
              | @tsv
            ' python-scan.json | column -t -s $'\t'
            
            echo ""
            echo "::warning::$VULN_COUNT vuln√©rabilit√©s HIGH/CRITICAL trouv√©es dans requirements.txt"
          else
            echo "‚úÖ Aucune vuln√©rabilit√© HIGH/CRITICAL trouv√©e dans requirements.txt"
          fi
      
      - name: Scanner vuln√©rabilit√©s de l'image Docker
        id: scan-docker
        continue-on-error: true
        run: |
          echo ""
          echo "üîç Scan des vuln√©rabilit√©s dans l'image Docker imgvulne:1.1"
          echo "=========================================================="
          
          # Scan avec Trivy
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -v "$HOME/.cache/trivy":/root/.cache/ \
            aquasec/trivy:latest image --format json --severity HIGH,CRITICAL imgvulne:1.1 \
          > docker-scan.json
          
          # Compter les vuln√©rabilit√©s
          DOCKER_VULN_COUNT=$(jq '[.Results[]?.Vulnerabilities[]?] | length' docker-scan.json)
          
          echo "DOCKER_VULN_COUNT=$DOCKER_VULN_COUNT" >> $GITHUB_ENV
          
          if [ "$DOCKER_VULN_COUNT" -gt 0 ]; then
            echo "‚ö†Ô∏è  $DOCKER_VULN_COUNT vuln√©rabilit√©s trouv√©es dans l'image Docker"
            echo ""
            echo "D√©tails des vuln√©rabilit√©s :"
            echo "----------------------------"
            
            jq -r '
              ["TARGET","PACKAGE","VERSION","VULN√âRABILIT√â","S√âV√âRIT√â"],
              (.Results[]? as $r | 
                $r.Vulnerabilities[]? | 
                [$r.Target, .PkgName, .InstalledVersion, .VulnerabilityID, .Severity]) 
              | @tsv
            ' docker-scan.json | column -t -s $'\t'
            
            echo ""
            echo "::warning::$DOCKER_VULN_COUNT vuln√©rabilit√©s HIGH/CRITICAL trouv√©es dans l'image Docker"
          else
            echo "‚úÖ Aucune vuln√©rabilit√© HIGH/CRITICAL trouv√©e dans l'image Docker"
          fi
      
      - name: R√©sum√© des vuln√©rabilit√©s
        if: always()
        run: |
          echo ""
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë        R√âSUM√â DU SCAN DE VULN√âRABILIT√âS             ‚ïë"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
          echo ""
          
          TOTAL_VULN=$((${VULN_COUNT:-0} + ${DOCKER_VULN_COUNT:-0}))
          
          echo "üìä Vuln√©rabilit√©s Python (requirements.txt) : ${VULN_COUNT:-0}"
          echo "üìä Vuln√©rabilit√©s Docker (image)            : ${DOCKER_VULN_COUNT:-0}"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üìä TOTAL                                    : $TOTAL_VULN"
          echo ""
          
          if [ "$TOTAL_VULN" -gt 0 ]; then
            echo "‚ö†Ô∏è  ACTION REQUISE : Des vuln√©rabilit√©s ont √©t√© d√©tect√©es !"
            echo ""
            echo "Recommandations :"
            echo "  1. Examiner les vuln√©rabilit√©s list√©es ci-dessus"
            echo "  2. Mettre √† jour les packages vuln√©rables"
            echo "  3. V√©rifier les CVE sur https://nvd.nist.gov/"
            echo ""
            echo "::error::$TOTAL_VULN vuln√©rabilit√©s HIGH/CRITICAL d√©tect√©es"
            exit 1
          else
            echo "‚úÖ Aucune vuln√©rabilit√© HIGH/CRITICAL d√©tect√©e"
            echo "‚úÖ L'image est s√©curis√©e"
          fi
      
      - name: Uploader les rapports de scan
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vulnerability-reports
          path: |
            python-scan.json
            docker-scan.json
          retention-days: 30
      
      - name: Cr√©er un rapport Markdown
        if: always()
        run: |
          cat > vulnerability-report.md << 'EOF'
          # üîí Rapport de Scan de Vuln√©rabilit√©s
          
          **Date:** $(date '+%Y-%m-%d %H:%M:%S')
          **Branche:** ${{ github.ref_name }}
          **Commit:** ${{ github.sha }}
          
          ---
          
          ## üìä R√©sum√©
          
          | Cat√©gorie | Vuln√©rabilit√©s HIGH/CRITICAL |
          |-----------|------------------------------|
          | Python (requirements.txt) | ${VULN_COUNT:-0} |
          | Image Docker | ${DOCKER_VULN_COUNT:-0} |
          | **TOTAL** | **$((${VULN_COUNT:-0} + ${DOCKER_VULN_COUNT:-0}))** |
          
          ---
          
          ## üîç D√©tails Python
          
          EOF
          
          if [ "${VULN_COUNT:-0}" -gt 0 ]; then
            echo "### ‚ö†Ô∏è Vuln√©rabilit√©s trouv√©es" >> vulnerability-report.md
            echo "" >> vulnerability-report.md
            jq -r '
              .Results[]?.Vulnerabilities[]? | 
              "- **\(.VulnerabilityID)** (\(.Severity)) - \(.PkgName) \(.InstalledVersion)\n  - \(.Title)\n  - Fix: \(.FixedVersion // "Non disponible")\n"
            ' python-scan.json >> vulnerability-report.md
          else
            echo "‚úÖ Aucune vuln√©rabilit√© d√©tect√©e" >> vulnerability-report.md
          fi
          
          cat >> vulnerability-report.md << 'EOF'
          
          ---
          
          ## üê≥ D√©tails Docker
          
          EOF
          
          if [ "${DOCKER_VULN_COUNT:-0}" -gt 0 ]; then
            echo "### ‚ö†Ô∏è Vuln√©rabilit√©s trouv√©es" >> vulnerability-report.md
            echo "" >> vulnerability-report.md
            jq -r '
              .Results[]? | 
              "#### \(.Target)\n" + 
              (
                .Vulnerabilities[]? | 
                "- **\(.VulnerabilityID)** (\(.Severity)) - \(.PkgName) \(.InstalledVersion)\n  - \(.Title)\n  - Fix: \(.FixedVersion // "Non disponible")\n"
              )
            ' docker-scan.json >> vulnerability-report.md
          else
            echo "‚úÖ Aucune vuln√©rabilit√© d√©tect√©e" >> vulnerability-report.md
          fi
          
          echo "" >> vulnerability-report.md
          echo "---" >> vulnerability-report.md
          echo "*G√©n√©r√© automatiquement par GitHub Actions*" >> vulnerability-report.md
      
      - name: Uploader le rapport Markdown
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vulnerability-report-markdown
          path: vulnerability-report.md
          retention-days: 30
      
      - name: Commenter la PR avec le r√©sum√©
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('vulnerability-report.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });
